{"info":{"title":"Pgpass 連線 Dbeaver feat. GCP","fileName":"pgpass-dbeaver","description":"如何使用 Pgpass 連線 Dbeaver","createdAt":"2025-11-15T00:00:00.000Z","updatedAt":"2025-11-15T00:00:00.000Z","tags":["database","postgresql","dbeaver"]},"content":"<h1 id=\"Pgpass 連線 Dbeaver feat. GCP\" title=\"Pgpass 連線 Dbeaver feat. GCP\">Pgpass 連線 Dbeaver feat. GCP</h1>\n<h2 id=\"安裝\" title=\"安裝\"><a href=\"#安裝\">安裝</a></h2>\n<h3>1. 安裝 dbeaver</h3>\n<pre class=\"hljs\"><code>brew install --cask dbeaver-community\n</code></pre>\n<h3>2. 安裝 GCP CLI</h3>\n<p>前往官方網站下載 SDK：<a  href=\"https://cloud.google.com/sdk/docs/install?hl=zh-cn#installation_instructions\" target=\"_blank\" rel=\"noreferrer noopener\">https://cloud.google.com/sdk/docs/install</a></p>\n<p>下載後執行安裝（請先 <code>cd</code> 至檔案所在位置）：</p>\n<pre class=\"hljs\"><code>./google-cloud-sdk/install.sh\n</code></pre>\n<h3>3. 安裝 GCP Cloud SQL Proxy</h3>\n<p>下載至 Home 目錄並設權限：</p>\n<pre class=\"hljs\"><code>curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.15.2/cloud-sql-proxy.darwin.arm64\n</code></pre>\n<pre class=\"hljs\"><code><span class=\"hljs-built_in\">chmod</span> +x cloud-sql-proxy\n</code></pre>\n<p>重新載入環境變數設定：</p>\n<pre class=\"hljs\"><code><span class=\"hljs-built_in\">source</span> ~/.zshrc\n</code></pre>\n<p>登入 GCP 帳號：</p>\n<pre class=\"hljs\"><code>gcloud auth application-default login\n</code></pre>\n<table>\n<thead>\n<tr>\n<th>你要做的事</th>\n<th>建議用哪個指令</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>想在 CLI 操作 GCP</td>\n<td><code>gcloud auth login</code></td>\n</tr>\n<tr>\n<td>在 Python、Node.js 寫 code 存取 GCP 資源</td>\n<td><code>gcloud auth application-default login</code></td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"Pgpass 設定\" title=\"Pgpass 設定\"><a href=\"#Pgpass 設定\">Pgpass 設定</a></h2>\n<h3>1. 建立 <code>.pgpass</code> 檔案</h3>\n<pre class=\"hljs\"><code>touch ~/.pgpass\n</code></pre>\n<pre class=\"hljs\"><code>vi ~/.pgpass\n</code></pre>\n<p>檔案內容格式如下：</p>\n<pre class=\"hljs\"><code>localhost:{PORT}:{DB name}:{email}:__TOKEN__\n</code></pre>\n<p>說明：</p>\n<ul>\n<li><code>PORT</code> 可自訂，但需與 DBeaver 設定一致</li>\n<li><code>DB name</code> 根據實際使用的環境命名</li>\n<li><code>email</code> 請填入你自己的帳號（如 <code>xxx.xxx@test.com.tw</code>）</li>\n</ul>\n<p>範例：</p>\n<pre class=\"hljs\"><code>localhost:5433:dev:{email}:__TOKEN__\nlocalhost:5434:uat:{email}:__TOKEN__\n</code></pre>\n<h3>2. 設定 alias 與自動更新 token</h3>\n<p>建立 alias 設定檔：</p>\n<pre class=\"hljs\"><code>touch ~/.oh-my-zsh/custom/alias.zsh\n</code></pre>\n<pre class=\"hljs\"><code>vi ~/.oh-my-zsh/custom/alias.zsh\n</code></pre>\n<p>加入以下內容：</p>\n<pre class=\"hljs\"><code><span class=\"hljs-built_in\">export</span> GCLOUD_EMAIL=xxx.xxx@test.com.tw\n\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-function\"><span class=\"hljs-title\">pg_update_iam</span></span>() {\n  <span class=\"hljs-keyword\">if</span> [[ -z <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$GCLOUD_EMAIL</span>&quot;</span> ]]; <span class=\"hljs-keyword\">then</span>\n    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;GCLOUD_EMAIL is not set. Please add &#x27;export GCLOUD_EMAIL=your_email&#x27; to alias.zsh&quot;</span>\n    <span class=\"hljs-built_in\">return</span> 1\n  <span class=\"hljs-keyword\">fi</span>\n\n  <span class=\"hljs-built_in\">local</span> token=$(gcloud auth print-access-token --account=<span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$GCLOUD_EMAIL</span>&quot;</span>)\n\n  <span class=\"hljs-keyword\">if</span> [[ -z <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$token</span>&quot;</span> ]]; <span class=\"hljs-keyword\">then</span>\n    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;Failed to get token for <span class=\"hljs-variable\">$GCLOUD_EMAIL</span>&quot;</span>\n    <span class=\"hljs-built_in\">return</span> 1\n  <span class=\"hljs-keyword\">fi</span>\n\n  sed -i <span class=\"hljs-string\">&quot;&quot;</span> <span class=\"hljs-string\">&quot;s|^localhost:5433:ktw_dev:<span class=\"hljs-variable\">$GCLOUD_EMAIL</span>:.*$|localhost:5433:ktw_dev:<span class=\"hljs-variable\">$GCLOUD_EMAIL</span>:<span class=\"hljs-variable\">$token</span>|&quot;</span> ~/.pgpass\n  sed -i <span class=\"hljs-string\">&quot;&quot;</span> <span class=\"hljs-string\">&quot;s|^localhost:5434:ktw_uat:<span class=\"hljs-variable\">$GCLOUD_EMAIL</span>:.*$|localhost:5434:ktw_uat:<span class=\"hljs-variable\">$GCLOUD_EMAIL</span>:<span class=\"hljs-variable\">$token</span>|&quot;</span> ~/.pgpass\n}\n\n<span class=\"hljs-built_in\">alias</span> pg_proxy_dev=<span class=\"hljs-string\">&#x27;pg_update_iam &amp;&amp; ~/cloud-sql-proxy dev-everything:asia-east1:ktw-dev --port=5433&#x27;</span>\n<span class=\"hljs-built_in\">alias</span> pg_proxy_uat=<span class=\"hljs-string\">&#x27;pg_update_iam &amp;&amp; ~/cloud-sql-proxy uat-everything:asia-east1:ktw-uat --port=5434&#x27;</span>\n</code></pre>\n<p>套用 alias 設定：</p>\n<pre class=\"hljs\"><code><span class=\"hljs-built_in\">source</span> ~/.zshrc\n</code></pre>\n<h2 id=\"開啟 SQL proxy\" title=\"開啟 SQL proxy\"><a href=\"#開啟 SQL proxy\">開啟 SQL proxy</a></h2>\n<p>開啟 proxy，讓 DB 可被連線：</p>\n<pre class=\"hljs\"><code>pg_proxy_dev  <span class=\"hljs-comment\"># 開啟 Dev 的 proxy</span>\npg_proxy_uat  <span class=\"hljs-comment\"># 開啟 UAT 的 proxy</span>\n</code></pre>\n<h2 id=\"DBeaver 設定\" title=\"DBeaver 設定\"><a href=\"#DBeaver 設定\">DBeaver 設定</a></h2>\n<ol>\n<li>\n<p><code>Port</code> 設為 <code>.pgpass</code> 中對應的 port</p>\n</li>\n<li>\n<p><code>DB name</code> 依據環境命名（如 <code>dev</code>、<code>uat</code>）</p>\n</li>\n<li>\n<p>選擇 PostgreSQL PgPass 模式和<code>Username</code> 填入 emai</p>\n</li>\n<li>\n<p>測試是否連線成功，無問題後，點擊 Finish</p>\n</li>\n</ol>\n<p><img src=\"https://hackmd.io/_uploads/rJU9aRa-Zl.png\" alt=\"image\" /></p>\n<p>接著可執行 SQL 測試資料(依自己測試資料)是否正常返回：</p>\n<pre class=\"hljs\"><code><span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-operator\">*</span> <span class=\"hljs-keyword\">FROM</span> product.title\n</code></pre>\n<p><strong>補充：</strong> 設定 Default Schema</p>\n<p>可於 DBeaver 設定 default schema 後，簡化查詢語法：</p>\n<p><img src=\"https://hackmd.io/_uploads/SylmTCpbbl.png\" alt=\"image\" /></p>\n<pre class=\"hljs\"><code><span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-operator\">*</span> <span class=\"hljs-keyword\">FROM</span> title\n</code></pre>\n<h2 id=\"後記\" title=\"後記\"><a href=\"#後記\">後記</a></h2>\n<p>連線方式比較：</p>\n<h3>使用帳號密碼連線（直連 GCP）</h3>\n<p><strong>需求：</strong></p>\n<ul>\n<li>GCP DB 的 public IP</li>\n<li>使用者帳號與密碼</li>\n</ul>\n<p><strong>缺點：</strong></p>\n<ul>\n<li>存在資安風險，會洩露資料庫的真實 IP</li>\n</ul>\n<h3>使用 Cloud SQL Proxy + Pgpass</h3>\n<p><strong>流程：</strong></p>\n<ul>\n<li>DBeaver → 透過本地 <code>.pgpass</code> 連線</li>\n<li>Proxy → 連接至 GCP Cloud SQL，使用 IAM token 驗證</li>\n</ul>\n<p><strong>優點：</strong></p>\n<ul>\n<li>不需暴露 GCP 資料庫 IP</li>\n<li>使用動態 Token，安全性更高</li>\n<li>可自動更新 Token，維護方便</li>\n</ul>\n<blockquote>\n<h3>Proxy</h3>\n<ul>\n<li>\n<p>Dbeaver ⇒ Pgpass：</p>\n<p>連接 dbeaver 到 local 設定</p>\n</li>\n<li>\n<p>Pgpass ⇒ GCP：</p>\n<p>連接 local 設定到 GCP</p>\n</li>\n</ul>\n<p>Dbeaver : 設定 pgpass 方式，須與 pgpass port 設定一致</p>\n<p>Pgpass：存放 gcp token 地方 + 設定 local db port</p>\n</blockquote>\n","toc":{"title":"Pgpass 連線 Dbeaver feat. GCP","subtitles":["安裝","Pgpass 設定","開啟 SQL proxy","DBeaver 設定","後記"]},"wordCount":892}